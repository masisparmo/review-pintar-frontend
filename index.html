<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reviewer Pintar - Analis Ulasan AI</title>
    <!-- Memuat Tailwind CSS untuk styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Memuat Font Inter dari Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Menggunakan font Inter sebagai default */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Style untuk spinner/loader */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Style untuk item daftar yang bisa diklik */
        .place-item {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .place-item:hover {
            background-color: #f0f4f8;
        }
        /* Style untuk konsol log */
        #log-console {
            font-family: 'Courier New', Courier, monospace;
            background-color: #2d3748; /* bg-gray-800 */
            color: #e2e8f0; /* text-gray-300 */
            height: 200px;
            overflow-y: scroll;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
        }
        .log-entry {
            margin-bottom: 0.5rem;
        }
        .log-entry.info { color: #63b3ed; } /* text-blue-400 */
        .log-entry.success { color: #68d391; } /* text-green-400 */
        .log-entry.error { color: #fc8181; } /* text-red-400 */
        /* Style untuk kontainer peta */
        #map {
            height: 400px;
            width: 100%;
            border-radius: 0.75rem; /* rounded-xl */
            margin-bottom: 2rem; /* mb-8 */
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-2xl">
        
        <!-- Header Aplikasi -->
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-blue-600">Reviewer Pintar</h1>
            <p class="text-lg text-gray-600 mt-2">Pilih tempat di dekat Anda untuk dianalisis oleh AI</p>
        </header>

        <!-- Kontrol Utama -->
        <main class="bg-white p-6 rounded-xl shadow-md">
            <!-- Pesan untuk mengaktifkan lokasi -->
            <div id="location-prompt" class="text-center">
                <p class="font-semibold text-lg mb-4">Untuk memulai, izinkan kami mengakses lokasi Anda.</p>
                <button id="getLocationBtn" class="bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors duration-300 shadow-sm">
                    Temukan Tempat Terdekat
                </button>
            </div>

            <!-- Pilihan Tipe Tempat (muncul setelah lokasi didapat) -->
            <div id="place-type-selector" class="hidden">
                <p class="font-semibold text-lg mb-4 text-center">Saya sedang mencari...</p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <button data-type="cafe" class="place-type-btn w-full bg-gray-200 text-gray-800 font-bold py-3 px-4 rounded-lg hover:bg-blue-200 transition-colors">Kafe ‚òï</button>
                    <button data-type="restaurant" class="place-type-btn w-full bg-gray-200 text-gray-800 font-bold py-3 px-4 rounded-lg hover:bg-blue-200 transition-colors">Restoran üçΩÔ∏è</button>
                    <button data-type="hotel" class="place-type-btn w-full bg-gray-200 text-gray-800 font-bold py-3 px-4 rounded-lg hover:bg-blue-200 transition-colors">Hotel üè®</button>
                </div>
            </div>
        </main>
        
        <!-- Kontainer Peta dan Daftar Tempat -->
        <div id="map-and-list-container" class="mt-8 hidden">
            <!-- Div untuk Peta Google Maps -->
            <div id="map"></div>
            
            <!-- Daftar Tempat Terdekat -->
            <div id="nearby-places">
                <h2 class="text-2xl font-bold mb-4">Pilih Tempat untuk Dianalisis:</h2>
                <div id="places-loader" class="flex justify-center items-center py-8">
                    <div class="loader"></div>
                    <p class="ml-4 text-gray-600">Mencari tempat terdekat...</p>
                </div>
                <ul id="places-list" class="bg-white rounded-xl shadow-md divide-y"></ul>
            </div>
        </div>


        <!-- Area Hasil Analisis -->
        <div id="results" class="mt-8 hidden">
            <div id="analysis-loader" class="flex justify-center items-center py-8">
                <div class="loader"></div>
                <p class="ml-4 text-gray-600">Menganalisis ulasan...</p>
            </div>
            <div id="error" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg text-center">
                <strong class="font-bold">Oops!</strong>
                <span class="block sm:inline" id="errorMessage">Terjadi kesalahan.</span>
            </div>
            <div id="resultsContent" class="hidden bg-white p-6 rounded-xl shadow-md">
                <h2 class="text-2xl font-bold mb-4 border-b pb-2">Hasil Analisis AI</h2>
                <div class="mb-6">
                    <h3 class="text-xl font-semibold mb-2">Sentimen Keseluruhan</h3>
                    <p id="overallSentiment" class="text-lg font-medium p-3 rounded-lg"></p>
                </div>
                <div class="mb-6">
                    <h3 class="text-xl font-semibold mb-2">Ringkasan AI</h3>
                    <p id="summary" class="text-gray-700 leading-relaxed bg-gray-50 p-4 rounded-lg"></p>
                </div>
                <div>
                    <h3 class="text-xl font-semibold mb-2">Aspek Utama yang Dibicarakan</h3>
                    <ul id="aspects" class="space-y-2"></ul>
                </div>
            </div>
        </div>

        <!-- Konsol Log untuk Debugging -->
        <div id="log-console-container" class="mt-8">
            <h3 class="text-lg font-semibold">Log Proses:</h3>
            <div id="log-console"></div>
        </div>

    </div>

    <!-- PENTING: Muat Google Maps JavaScript API TANPA callback -->
    <!-- PERBAIKAN: API Key Anda sudah dimasukkan di sini. -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAJCwaPENYvnmqoJ_d8N3u0DvAMXJMzbqo&loading=async"></script>

    <script>
        // --- KONFIGURASI ---
        const BACKEND_URL = 'https://review-pintar-backend-523600897133.asia-southeast1.run.app/api/analyze'; 
        let userLocation = null;
        let map;
        let markers = [];
        let Place, Geometry; // Variabel untuk menyimpan library yang diimpor
        
        // --- ELEMEN DOM ---
        let logConsole, getLocationBtn, locationPromptDiv, placeTypeSelectorDiv, mapAndListContainer, nearbyPlacesDiv, placesLoader, placesList, resultsDiv, analysisLoader, errorDiv, errorMessage, resultsContent, overallSentimentEl, summaryEl, aspectsList;

        /**
         * Fungsi untuk menambahkan pesan ke konsol log di UI.
         */
        function addLog(message, type = 'info') {
            if (!logConsole) {
                logConsole = document.getElementById('log-console');
            }
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logConsole.appendChild(logEntry);
            logConsole.scrollTop = logConsole.scrollHeight;
        }
        
        /**
         * Fungsi utama yang dijalankan saat halaman dimuat.
         */
        async function main() {
            addLog("Memulai script frontend...");

            // Mengambil elemen DOM
            logConsole = document.getElementById('log-console');
            getLocationBtn = document.getElementById('getLocationBtn');
            locationPromptDiv = document.getElementById('location-prompt');
            placeTypeSelectorDiv = document.getElementById('place-type-selector');
            mapAndListContainer = document.getElementById('map-and-list-container');
            nearbyPlacesDiv = document.getElementById('nearby-places');
            placesLoader = document.getElementById('places-loader');
            placesList = document.getElementById('places-list');
            resultsDiv = document.getElementById('results');
            analysisLoader = document.getElementById('analysis-loader');
            errorDiv = document.getElementById('error');
            errorMessage = document.getElementById('errorMessage');
            resultsContent = document.getElementById('resultsContent');
            overallSentimentEl = document.getElementById('overallSentiment');
            summaryEl = document.getElementById('summary');
            aspectsList = document.getElementById('aspects');

            try {
                // === PERBAIKAN UTAMA: Mengimpor library secara dinamis ===
                const { Place } = await google.maps.importLibrary("places");
                const { spherical } = await google.maps.importLibrary("geometry");
                window.Place = Place; // Menyimpan referensi global jika diperlukan
                window.Geometry = spherical;
                addLog("Library 'Places' dan 'Geometry' berhasil dimuat.", 'success');
            } catch (error) {
                addLog(`Gagal memuat library Google Maps: ${error.message}`, 'error');
                return; // Hentikan eksekusi jika library gagal dimuat
            }
            
            addLog("Aplikasi siap. Menunggu aksi pengguna...");
            getLocationBtn.addEventListener('click', getUserLocation);
            
            document.querySelectorAll('.place-type-btn').forEach(button => {
                button.addEventListener('click', () => findNearbyPlaces(button.dataset.type));
            });
        }

        /**
         * Meminta lokasi GPS pengguna.
         */
        function getUserLocation() {
            addLog("Mencoba mendapatkan lokasi GPS...");
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    addLog(`Lokasi GPS berhasil didapat: Lat: ${userLocation.lat}, Lng: ${userLocation.lng}`, 'success');
                    locationPromptDiv.classList.add('hidden');
                    placeTypeSelectorDiv.classList.remove('hidden');
                }, () => {
                    addLog('Gagal mendapatkan lokasi. Izin ditolak oleh pengguna.', 'error');
                    alert('Gagal mendapatkan lokasi. Pastikan Anda telah memberikan izin.');
                });
            } else {
                addLog('Browser tidak mendukung Geolocation.', 'error');
                alert('Browser Anda tidak mendukung Geolocation.');
            }
        }
        
        /**
         * Inisialisasi peta Google Maps.
         */
        function initMap() {
            map = new google.maps.Map(document.getElementById("map"), {
                center: userLocation,
                zoom: 15,
            });
            // Menambahkan marker untuk lokasi pengguna
            new google.maps.Marker({
                position: userLocation,
                map: map,
                title: "Lokasi Anda",
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 8,
                    fillColor: "#4285F4",
                    fillOpacity: 1,
                    strokeWeight: 2,
                    strokeColor: "white",
                },
            });
        }

        /**
         * Mencari tempat terdekat menggunakan Places API yang baru.
         */
        async function findNearbyPlaces(type) {
            if (!userLocation) {
                addLog('Lokasi pengguna tidak ditemukan untuk memulai pencarian.', 'error');
                return;
            }
            
            resetUI();
            mapAndListContainer.classList.remove('hidden');
            placesLoader.classList.remove('hidden');
            placesList.innerHTML = '';
            addLog(`Memulai pencarian tempat terdekat dengan tipe: '${type}'...`);
            
            initMap(); // Inisialisasi peta di sini

            const request = {
                includedTypes: [type],
                locationRestriction: {
                    center: {
                        lat: userLocation.lat,
                        lng: userLocation.lng,
                    },
                    radius: 1000, // Radius 1 km
                },
            };

            try {
                // Menggunakan referensi yang sudah diimpor
                const { places } = await window.Place.searchNearby(request);
                
                placesLoader.classList.add('hidden');
                addLog(`Pencarian selesai.`, 'info');

                if (places && places.length) {
                    addLog(`Ditemukan ${places.length} tempat. Menampilkan daftar...`, 'success');
                    renderNearbyPlaces(places);
                } else {
                    addLog(`Tidak ada tempat yang ditemukan.`, 'info');
                    placesList.innerHTML = `<li class="p-4 text-center text-gray-500">Tidak ada tempat yang ditemukan.</li>`;
                }
            } catch (error) {
                placesLoader.classList.add('hidden');
                addLog(`Pencarian gagal: ${error.message}`, 'error');
                placesList.innerHTML = `<li class="p-4 text-center text-gray-500">Pencarian gagal. Periksa konsol untuk detail.</li>`;
            }
        }

        /**
         * Menampilkan daftar tempat terdekat ke UI.
         */
        async function renderNearbyPlaces(places) {
            // Hapus marker lama
            markers.forEach(marker => marker.setMap(null));
            markers = [];
            
            let placesWithDetails = [];

            // === PERBAIKAN UTAMA: Mengambil detail untuk setiap tempat ===
            for (const place of places) {
                try {
                    await place.fetchFields({ fields: ['displayName', 'formattedAddress', 'location'] });
                    const distance = window.Geometry.computeDistanceBetween(
                        new google.maps.LatLng(userLocation.lat, userLocation.lng),
                        place.location
                    );
                    placesWithDetails.push({ ...place, distance });
                } catch (error) {
                    addLog(`Gagal mengambil detail untuk place ID: ${place.id}. Error: ${error.message}`, 'error');
                }
            }

            // Urutkan berdasarkan jarak terdekat
            placesWithDetails.sort((a, b) => a.distance - b.distance);

            placesWithDetails.forEach(place => {
                // Tambahkan marker ke peta
                const marker = new google.maps.Marker({
                    position: place.location,
                    map,
                    title: place.displayName,
                });
                markers.push(marker);

                // Buat item di daftar
                const li = document.createElement('li');
                li.className = 'place-item p-4';
                li.dataset.placeId = place.id;

                const placeName = document.createElement('h3');
                placeName.className = 'font-semibold text-lg';
                placeName.textContent = place.displayName;

                const placeVicinity = document.createElement('p');
                placeVicinity.className = 'text-gray-600 text-sm';
                placeVicinity.textContent = place.formattedAddress;
                
                const placeDistance = document.createElement('p');
                placeDistance.className = 'text-blue-600 font-semibold text-sm mt-1';
                placeDistance.textContent = `Jarak: ${Math.round(place.distance)} meter`;

                li.appendChild(placeName);
                li.appendChild(placeVicinity);
                li.appendChild(placeDistance);
                
                li.addEventListener('click', () => handleAnalysis(place.id, place.displayName));
                placesList.appendChild(li);
            });
        }

        /**
         * Mengirim Place ID ke backend untuk dianalisis.
         */
        async function handleAnalysis(placeId, placeName) {
            addLog(`Memulai analisis untuk '${placeName}' (ID: ${placeId})...`);
            resetUI();
            mapAndListContainer.classList.add('hidden');
            resultsDiv.classList.remove('hidden');
            analysisLoader.classList.remove('hidden');

            try {
                const response = await fetch(BACKEND_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ placeId: placeId }),
                });
                
                addLog(`Menerima respons dari backend dengan status: ${response.status}`, response.ok ? 'info' : 'error');

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }

                const rawData = await response.json();
                addLog('Berhasil mem-parsing respons JSON dari backend.', 'success');
                const data = JSON.parse(rawData);
                renderResults(data);

            } catch (err) {
                addLog(`Terjadi error saat analisis: ${err.message}`, 'error');
                showError(err.message);
            } finally {
                analysisLoader.classList.add('hidden');
            }
        }
        
        function renderResults(data) {
            addLog('Menampilkan hasil analisis ke UI.', 'info');
            overallSentimentEl.textContent = data.sentimen_keseluruhan || 'Tidak tersedia';
            if (data.sentimen_keseluruhan === 'Positif') {
                overallSentimentEl.className = 'text-lg font-medium p-3 rounded-lg bg-green-100 text-green-800';
            } else if (data.sentimen_keseluruhan === 'Negatif') {
                overallSentimentEl.className = 'text-lg font-medium p-3 rounded-lg bg-red-100 text-red-800';
            } else {
                overallSentimentEl.className = 'text-lg font-medium p-3 rounded-lg bg-yellow-100 text-yellow-800';
            }
            summaryEl.textContent = data.ringkasan || 'Tidak ada ringkasan.';
            aspectsList.innerHTML = '';
            if (data.aspek_utama && Array.isArray(data.aspek_utama)) {
                data.aspek_utama.forEach(item => {
                    const li = document.createElement('li');
                    li.className = 'p-3 bg-gray-50 rounded-lg flex justify-between items-center';
                    const aspectName = document.createElement('span');
                    aspectName.className = 'font-medium';
                    aspectName.textContent = item.aspek;
                    const aspectSentiment = document.createElement('span');
                    aspectSentiment.textContent = item.sentimen;
                    if (item.sentimen === 'Positif') {
                        aspectSentiment.className = 'px-2 py-1 text-xs font-semibold text-green-800 bg-green-200 rounded-full';
                    } else if (item.sentimen === 'Negatif') {
                        aspectSentiment.className = 'px-2 py-1 text-xs font-semibold text-red-800 bg-red-200 rounded-full';
                    } else {
                        aspectSentiment.className = 'px-2 py-1 text-xs font-semibold text-yellow-800 bg-yellow-200 rounded-full';
                    }
                    li.appendChild(aspectName);
                    li.appendChild(aspectSentiment);
                    aspectsList.appendChild(li);
                });
            } else {
                aspectsList.innerHTML = '<li>Tidak ada analisis aspek yang ditemukan.</li>';
            }
            resultsContent.classList.remove('hidden');
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        function resetUI() {
            resultsDiv.classList.add('hidden');
            analysisLoader.classList.add('hidden');
            errorDiv.classList.add('hidden');
            resultsContent.classList.add('hidden');
        }

        // Memanggil fungsi utama saat halaman dimuat
        main();
    </script>

</body>
</html>
